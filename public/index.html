<!DOCTYPE html>
<html lang="en"> <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBA-BAR Event List & Entry</title> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/stylesheet.css">
</head>

<body>

    <div class="dropdown menu-top-right">
        <button class="btn btn-menu-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-list"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
            <li><a class="dropdown-item" href="#" id="menu-show-list"><i
                        class="bi bi-calendar-event-fill me-2"></i>Event Overview</a></li>
            <li><a class="dropdown-item" href="#" id="menu-show-add-form"><i
                        class="bi bi-plus-circle-fill me-2"></i>Add Event</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" id="menu-show-help"><i
                        class="bi bi-info-circle-fill me-2"></i>Principles and Help</a></li>
        </ul>
    </div>

    <div class="container mt-4 mb-5">

        <div id="event-view">
            <h1 class="mb-4">EBA-BAR Event List</h1>
            <div id="filter-bar">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4 col-sm-12"> <label for="search-term" class="form-label">Search
                            (Title/Description)</label>
                        <input type="text" class="form-control form-control-sm" id="search-term"
                            placeholder="Enter search term...">
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <label for="type-filter" class="form-label">Type</label>
                        <select class="form-select form-select-sm" id="type-filter">
                            <option value="" selected>All</option>
                            <option value="Öffentlich">Public</option> <option value="Privat">Private</option> </select>
                    </div>
                    <div class="col-md-5 col-sm-6"> <label class="form-label">Month / Year</label>
                        <div class="input-group input-group-sm">
                            <select class="form-select form-select-sm" id="month-filter">
                                <option value="" selected>Month (All)</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select class="form-select form-select-sm" id="year-filter">
                                <option value="" selected>Year (All)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-1 col-sm-12 d-grid">
                        <button class="btn btn-secondary btn-sm" id="reset-filters" type="button">Reset</button>
                    </div>
                </div>
            </div>
            <div id="event-liste" class="list-group mt-4">
                <div id="loading" class="d-flex justify-content-center align-items-center p-5">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading Events...</span></div>
                    <span class="ms-3">Loading Events...</span>
                </div>
                </div>
        </div>

        <div id="add-form-view" class="d-none">
            <h1 class="mb-4">Add New Event</h1>
            <div class="add-form-container p-4 rounded">
                <form id="addEventForm" novalidate> <div class="mb-3">
                        <label for="add-title" class="form-label">Event Title*</label>
                        <input type="text" class="form-control" id="add-title" required> </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="add-date" class="form-label">Date*</label>
                            <input type="date" class="form-control" id="add-date" required> </div>
                        <div class="col-md-4">
                             <label for="add-startTime" class="form-label">Start Time (HH:MM)</label>
                             <input type="time" class="form-control" id="add-startTime"> </div>
                        <div class="col-md-4">
                            <label for="add-endTime" class="form-label">End Time (HH:MM)</label>
                            <input type="time" class="form-control" id="add-endTime"> </div>
                    </div>
                    <div class="mb-3">
                         <label for="add-description" class="form-label">Description</label>
                         <textarea class="form-control" id="add-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3"> <label class="form-label">Event Type*</label>
                        <div>
                            <div class="form-check form-check-inline"> <input class="form-check-input" type="radio"
                                    name="add-event-type" id="add-type-public" value="Öffentlich" checked required>
                                <label class="form-check-label" for="add-type-public">Public</label> </div>
                            <div class="form-check form-check-inline"> <input class="form-check-input" type="radio"
                                    name="add-event-type" id="add-type-private" value="Privat" required> <label
                                    class="form-check-label" for="add-type-private">Private</label> </div>
                        </div>
                    </div>
                    <div class="mb-3"> <label class="form-label">Required Resources <small
                                class="text-muted">(Multiple selection possible)</small></label>
                        <div id="add-resources-checkboxes">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="Retro Game Station" id="add-res-retro"><label class="form-check-label" for="add-res-retro">Retro Game Station</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="Beamer und Sofa" id="add-res-beamersofa"><label class="form-check-label" for="add-res-beamersofa">Projector and Sofa</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="Flipperkasten" id="add-res-flipper"><label class="form-check-label" for="add-res-flipper">Pinball Machine</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="1-2 Tische" id="add-res-tische12"><label class="form-check-label" for="add-res-tische12">1-2 Tables</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="2-4 Tische" id="add-res-tische24"><label class="form-check-label" for="add-res-tische24">2-4 Tables</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="add-resources" value="4-6 Tische" id="add-res-tische46"><label class="form-check-label" for="add-res-tische46">4-6 Tables</label></div>
                        </div>
                    </div>
                    <div class="mb-3"> <label for="add-responsible" class="form-label">Responsible Person</label> <input
                            type="text" class="form-control" id="add-responsible" aria-describedby="responsibleHelp">
                        <div id="responsibleHelp" class="form-text">(First Name, Last Name, Phone, Address)</div>
                    </div>
                    <div class="mb-3"> <label for="add-participantInfo" class="form-label">Additional Info for Participants</label> <textarea
                            class="form-control" id="add-participantInfo" rows="4" aria-describedby="participantInfoHelpAdd"></textarea>
                            <div id="participantInfoHelpAdd" class="form-text">
                                Extra information, including longer descriptions. Not shown in the main event list.
                            </div>
                    </div>
                    <div class="mb-3">
                      <label for="add-event-image" class="form-label">Upload Image (Optional)</label>
                      <input class="form-control" type="file" id="add-event-image" name="eventImage" accept="image/png, image/jpeg, image/gif">
                      <img id="add-image-preview" src="#" alt="Image Preview" class="image-preview" /> </div>
                    <div class="d-flex justify-content-end"> <button type="submit" class="btn btn-success"
                            id="addEventButton"> <span class="spinner-border spinner-border-sm d-none me-1"></span><i
                                class="bi bi-plus-lg me-1"></i> Add Event </button> </div>
                    <div id="add-form-feedback" class="mt-3"></div>
                </form>
            </div>
        </div>

        <div id="help-view" class="d-none">
            <h1 class="mb-4">Principles and Help</h1>
            <div class="help-view-container p-4 rounded">
                <h2>Genossenschaftsraum - Unsere Vision</h2>
                <p>Der Genossenschaftsraum ist unser gemeinsames Wohnzimmer...</p>
                <h3 class="mt-4">Die wichtigsten Regeln - Einfach und klar</h3>
                <h4>Immer offen für alle</h4>
                <p>Der Genossenschaftsraum gehört uns allen...</p>
                <ul>
                    <li><strong>Password (Entry/Editing):</strong> <code>******</code></li> </ul>
                 <p>Do you have ideas...? Share them via <a href="mailto:event@eba-zuerich.ch">event@eba-zuerich.ch</a>.</p>
            </div>
        </div>

        <div id="error-message" class="alert alert-danger mt-4 d-none" role="alert"></div>
        <div id="success-message" class="alert alert-success mt-4 d-none" role="alert"></div>

    </div> <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm" novalidate>
                        <input type="hidden" id="edit-id">
                        <div class="mb-3"> <label for="edit-title" class="form-label">Event Title*</label> <input
                                type="text" class="form-control" id="edit-title" required> </div>
                        <div class="row mb-3">
                            <div class="col-md-4"> <label for="edit-date" class="form-label">Date*</label> <input
                                    type="date" class="form-control" id="edit-date" required> </div>
                            <div class="col-md-4"> <label for="edit-startTime" class="form-label">Start Time (HH:MM)</label> <input type="time" class="form-control" id="edit-startTime"> </div>
                            <div class="col-md-4"> <label for="edit-endTime" class="form-label">End Time (HH:MM)</label> <input type="time" class="form-control" id="edit-endTime"> </div>
                        </div>
                        <div class="mb-3"> <label for="edit-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-description" rows="3"></textarea> </div>
                        <div class="mb-3"> <label class="form-label">Event Type*</label>
                            <div>
                                <div class="form-check form-check-inline"> <input class="form-check-input" type="radio"
                                        name="edit-event-type" id="edit-type-public" value="Öffentlich" required> <label
                                        class="form-check-label" for="edit-type-public">Public</label> </div>
                                <div class="form-check form-check-inline"> <input class="form-check-input" type="radio"
                                        name="edit-event-type" id="edit-type-private" value="Privat" required> <label
                                        class="form-check-label" for="edit-type-private">Private</label> </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Required Resources <small class="text-muted">(Multiple selection possible)</small></label>
                            <div id="edit-resources-checkboxes">
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="Retro Game Station" id="edit-res-retro"><label class="form-check-label" for="edit-res-retro">Retro Game Station</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="Beamer und Sofa" id="edit-res-beamersofa"><label class="form-check-label" for="edit-res-beamersofa">Projector and Sofa</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="Flipperkasten" id="edit-res-flipper"><label class="form-check-label" for="edit-res-flipper">Pinball Machine</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="1-2 Tische" id="edit-res-tische12"><label class="form-check-label" for="edit-res-tische12">1-2 Tables</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="2-4 Tische" id="edit-res-tische24"><label class="form-check-label" for="edit-res-tische24">2-4 Tables</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" name="edit-resources" value="4-6 Tische" id="edit-res-tische46"><label class="form-check-label" for="edit-res-tische46">4-6 Tables</label></div>
                            </div>
                        </div>
                        <div class="mb-3"> <label for="edit-responsible" class="form-label">Responsible Person</label>
                            <input type="text" class="form-control" id="edit-responsible"
                                aria-describedby="responsibleHelpEdit">
                            <div id="responsibleHelpEdit" class="form-text">(First Name, Last Name, Phone, Address)</div>
                        </div>
                        <div class="mb-3"> <label for="edit-participantInfo" class="form-label">Additional Info for Participants</label> <textarea
                            class="form-control" id="edit-participantInfo" rows="4" aria-describedby="participantInfoHelpEdit"></textarea>
                            <div id="participantInfoHelpEdit" class="form-text">
                                Extra information, including longer descriptions. Not shown in main list.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Image:</label>
                            <img id="edit-image-preview" src="#" alt="Current Event Image" class="image-preview" style="display: none;" /> <p id="no-edit-image" class="form-text" style="display: none;">No image uploaded for this event.</p> </div>
                        <div id="edit-form-feedback" class="mt-3"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteEventButton">
                        <span class="spinner-border spinner-border-sm d-none me-1"></span>
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEventButton">
                        <span class="spinner-border spinner-border-sm d-none me-1"></span> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Constants for Backend Field Names ---
        // Using lowercase keys, common for JSON/Firestore, matching the backend expectations now
        const FIELD_DATE = 'eventDate'; // Expects YYYY-MM-DD format for PUT/POST body
        const FIELD_TITLE = 'title';
        const FIELD_START_TIME = 'startTime';
        const FIELD_END_TIME = 'endTime';
        const FIELD_DESCRIPTION = 'description';
        const FIELD_RESOURCES = 'resources'; // Comma-separated string
        const FIELD_RESPONSIBLE = 'responsible';
        const FIELD_EVENT_TYPE = 'eventType';
        const FIELD_PARTICIPANT_INFO = 'participantInfo';
        const FIELD_IMAGE_URL = 'imageUrl'; // Field name for the image URL from GCS

        // --- Global Variables ---
        let allEvents = []; // Stores all fetched events

        // --- DOM References ---
        let eventView, addFormView, helpView, listElement, loadingElement, errorElement, successElement;
        let searchTermInput, monthFilterSelect, yearFilterSelect, resetFiltersButton, typeFilterSelect;
        let addForm, addEventButton, addSpinner, addFormFeedback, addEventImageInput, addImagePreview; // Image input/preview for Add form
        let menuShowList, menuShowAddForm, menuShowHelp;
        let editModalElement, editModal, editForm, saveEventButton, saveSpinner, editFormFeedback, editImagePreview, editEventIdInput, noEditImageText; // Image preview + ID input for Edit modal
        let deleteEventButton, deleteSpinner;

        // Backend API Base URL (adjust if testing locally with backend on different port or deployed)
        // For testing with node server.js locally where it serves this file, '' is fine.
        // If backend runs separately (e.g., node server.js) and you open file directly, use 'http://localhost:8080'
        const API_BASE_URL = '';

        /** Displays the specified view */
        function showView(viewId) {
            if (!eventView || !addFormView || !helpView) { console.error("View elements not found!"); return; }
            hideMessages();
            eventView.classList.add('d-none');
            addFormView.classList.add('d-none');
            helpView.classList.add('d-none');
            if (viewId === 'event-view') { eventView.classList.remove('d-none'); }
            else if (viewId === 'add-form-view') { addFormView.classList.remove('d-none'); if (addForm) addForm.reset(); clearAddFormFeedback(); }
            else if (viewId === 'help-view') { helpView.classList.remove('d-none'); }
        }

        /** Checks password against the backend API */
        async function checkPasswordApi(password) {
            showLoadingFeedback("Checking password...");
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                // Try to parse JSON even if response is not ok, to get error message
                const data = await response.json();
                hideMessages();
                if (!response.ok) {
                    throw new Error(data.error || `HTTP Error ${response.status}`);
                }
                return data.isValid; // Returns true or false
            } catch (error) {
                hideMessages();
                console.error("Error during password check:", error);
                showError(error);
                return false; // Invalid on error
            }
        }

        /** Prompts for password before showing Add form */
        async function promptForAddPassword() {
            const password = prompt("Password for event creation:");
            if (password === null) return; // User cancelled
            const isValid = await checkPasswordApi(password);
            if (isValid) {
                showView('add-form-view');
            } else if (isValid === false) { // Only show "Incorrect" if explicitly false
                showError({ message: "Incorrect password." });
            }
        }

        /** Prompts for password before opening Edit modal */
        async function promptForEditPassword(eventId) { // Takes Firestore event ID
            const password = prompt("Password for event editing:");
            if (password === null) return;
            const isValid = await checkPasswordApi(password);
            if (isValid) {
                openEditModal(eventId); // Calls with event ID
            } else if (isValid === false) {
                showError({ message: "Incorrect password." });
            }
        }

        /** Populates year filter dropdown */
        function populateFilters(events) {
             if (!yearFilterSelect) return;
             const years = new Set();
             events.forEach(event => {
                 const dateStr = event[FIELD_DATE]; // Use the date field (YYYY-MM-DD string from backend)
                 if (dateStr) {
                    try { years.add(dateStr.substring(0, 4)); } catch(e) {}
                  }
              });
             const sortedYears = Array.from(years).sort((a, b) => b.localeCompare(a));
             yearFilterSelect.innerHTML = '<option value="" selected>Year (All)</option>';
             sortedYears.forEach(year => {
                 const opt = document.createElement('option');
                 opt.value = year; opt.textContent = year;
                 yearFilterSelect.appendChild(opt);
             });
        }

        /** Applies filters and re-renders the event list */
        function applyFiltersAndRender() {
             if (!searchTermInput || !monthFilterSelect || !yearFilterSelect || !typeFilterSelect || !allEvents) { console.error("Filter inputs or events not ready."); return; }
             const searchTerm = searchTermInput.value.toLowerCase().trim();
             const selectedMonth = monthFilterSelect.value;
             const selectedYear = yearFilterSelect.value;
             const selectedType = typeFilterSelect.value;

             const filteredEvents = allEvents.filter(event => {
                 const title = String(event[FIELD_TITLE] || '').toLowerCase();
                 const desc = String(event[FIELD_DESCRIPTION] || '').toLowerCase();
                 const searchMatch = searchTerm === '' || title.includes(searchTerm) || desc.includes(searchTerm);

                 let dateMatch = true;
                 const eventDateStr = event[FIELD_DATE]; // Use YYYY-MM-DD string
                 if ((selectedMonth || selectedYear) && eventDateStr) {
                     const y = eventDateStr.substring(0, 4);
                     const m = eventDateStr.substring(5, 7);
                     dateMatch = (selectedYear === '' || y === selectedYear) && (selectedMonth === '' || m === selectedMonth);
                 } else if (selectedMonth || selectedYear) {
                     dateMatch = false; // Event must have a date if date filter is active
                 }

                 const eventType = String(event[FIELD_EVENT_TYPE] || '').trim();
                 const typeMatch = selectedType === '' || eventType === selectedType;

                 return searchMatch && dateMatch && typeMatch;
             });
             displayEvents(filteredEvents);
        }

        /** Displays the events in the list */
        function displayEvents(events) {
            if (!listElement || !loadingElement) { console.error("List/Loading element not found"); return; }
            console.log("displayEvents called for:", events.length, "Events");
            loadingElement.classList.add('d-none'); errorElement.classList.add('d-none');
            listElement.innerHTML = ''; // Clear previous list
            if (!events || events.length === 0) { listElement.innerHTML = '<p class="text-muted text-center p-3">No events match the current filters.</p>'; return; }

            let currentMonthYear = null;
            events.forEach(event => {
                // Month Separator Logic
                let eventMonthYear = null;
                const eventDateStr = event[FIELD_DATE]; // YYYY-MM-DD
                if (eventDateStr) {
                    eventMonthYear = eventDateStr.substring(0, 7); // YYYY-MM
                    if (eventMonthYear !== currentMonthYear) {
                        currentMonthYear = eventMonthYear;
                        try {
                            // Create date from YYYY-MM to format header correctly
                            const mhDate = new Date(eventMonthYear + '-01T00:00:00Z'); // Add day and time zone for stability
                            const mhString = mhDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric', timeZone: 'Europe/Zurich' }); // Use English locale
                            const sep = document.createElement('h2'); sep.className = 'mt-4 mb-3 h4 text-secondary month-separator'; sep.textContent = mhString; listElement.appendChild(sep);
                        } catch (e) { console.error("Error creating month header:", e); }
                    }
                }

                // Create Event Tile Element
                const eventElement = document.createElement('div');
                eventElement.classList.add('list-group-item', 'mb-3', 'p-3', 'event-kachel'); // Add 'event-kachel' class
                eventElement.dataset.id = event.id; // *** STORE FIRESTORE ID ***

                // Extract Data
                const title = String(event[FIELD_TITLE] || '');
                const eventType = String(event[FIELD_EVENT_TYPE] || '').trim();
                const description = String(event[FIELD_DESCRIPTION] || '');
                const startTime = String(event[FIELD_START_TIME] || '').substring(0, 5);
                const endTime = String(event[FIELD_END_TIME] || '').substring(0, 5);
                const resources = String(event[FIELD_RESOURCES] || '');
                const responsible = String(event[FIELD_RESPONSIBLE] || '');
                const participantInfo = String(event[FIELD_PARTICIPANT_INFO] || '');
                const imageUrl = event[FIELD_IMAGE_URL] || null;

                // Format Date for Display
                let displayDate = 'No Date';
                if (eventDateStr) {
                    try {
                        const d = new Date(eventDateStr + 'T00:00:00Z'); // Assume YYYY-MM-DD needs time part for correct Date object
                        if (!isNaN(d)) displayDate = d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Europe/Zurich' }); // Use English locale
                        else displayDate = 'Invalid Date';
                    } catch (e) { displayDate = 'Date Error'; }
                }

                // Format Time String
                let timeString = ''; if (startTime && endTime) timeString = `${startTime} - ${endTime}`; else if (startTime) timeString = `From ${startTime}`; else timeString = 'No Time Specified';
                // Event Type Badge
                let typeBadgeHTML = ''; if (eventType === 'Privat') typeBadgeHTML = `<span class="badge rounded-pill bg-danger">Private</span>`; else if (eventType === 'Öffentlich') typeBadgeHTML = `<span class="badge rounded-pill bg-success">Public</span>`;

                // Build Tile HTML
                eventElement.innerHTML = `
                    ${typeBadgeHTML ? `<div class="mb-2">${typeBadgeHTML}</div>` : ''}
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="mb-1 flex-grow-1"><span class="math-inline">\{title \|\| 'Untitled Event'\}</h5\>
<button type\="button" class\="btn btn\-sm btn\-outline\-secondary ms\-2 edit\-event\-btn" data\-id\="</span>{event.id}" aria-label="Edit"><i class="bi bi-pencil"></i></button> </div>
                    <div class="row align-items-center mt-2">
                        <div class="col-md-6"> <div class="d-flex flex-column">
                                <small class="fw-bold"><span class="math-inline">\{displayDate\}</small\>
<small class\="mb\-2"\></span>{timeString}</small>
                                <small>${responsible ? `<strong class="me-1">Responsible:</strong>${responsible}` : ''}</small>
                            </div>
                        </div>
                        <div class="col-md-6 border-start ps-md-3"> <div class="d-flex flex-column">
                                 ${description ? `<p class="mb-1 small"><strong class="me-1">Description:</strong>${description}</p>` : '<p class="mb-1 small">&nbsp;</p>'}
                                 <small>${resources ? `<strong class="me-1">Resources:</strong>${resources}` : ''}</small>
                            </div>
                        </div>
                    </div>

                    <div class="event-details mt-3 pt-3 border-top">
                        ${participantInfo ? `<h6>Additional Information for Participants:</h6><p class="small mb-2">${participantInfo.replace(/\n/g, '<br>')}</p>` : ''}
                        ${imageUrl ? `<h6>Image:</h6><img src="${imageUrl}" alt="Event Image for ${title}" class="event-image mb-0">` : '<p class="small fst-italic mb-0">No image available.</p>'}
                    </div>
                    `;
                listElement.appendChild(eventElement);
            });
        }

        // --- Feedback and Reset Functions (unchanged, implement if missing) ---
        function showError(error) {
            if (!errorElement) return; console.error("Error displayed:", error);
            let t = "An unknown error occurred.";
            if(typeof error==='string') t=error; else if(error&&error.message) t=error.message; else if(error&&error.error) t=error.error; else if(error&&error.name) t=`Error: ${error.name}`; hideMessages(); errorElement.textContent=`Error: ${t}`; errorElement.classList.remove('d-none');
        }
        function showSuccess(message) {
            if (!successElement) return; hideMessages(); successElement.textContent = message; successElement.classList.remove('d-none'); setTimeout(hideMessages, 4000);
        }
        function showLoadingFeedback(message) {
            if (!successElement) return; hideMessages(); successElement.textContent = message; successElement.classList.remove('alert-success'); successElement.classList.add('alert-info'); successElement.classList.remove('d-none');
        }
        function hideMessages() {
             if (errorElement) errorElement.classList.add('d-none'); if (successElement) { successElement.classList.add('d-none'); successElement.classList.remove('alert-info'); successElement.classList.add('alert-success'); }
        }
        function resetAllFilters() {
             if(searchTermInput) searchTermInput.value=''; if(monthFilterSelect) monthFilterSelect.value=''; if(yearFilterSelect) yearFilterSelect.value=''; if(typeFilterSelect) typeFilterSelect.value = ''; applyFiltersAndRender();
        }

        // --- Add Event Form Handling ---
        function handleAddEventSubmit(submitEvent) {
            submitEvent.preventDefault();
            if (!addEventButton || !addSpinner || !addFormFeedback || !addEventImageInput) return;

            addSpinner.classList.remove('d-none'); addEventButton.disabled = true; clearAddFormFeedback(); hideMessages();

            // Collect form data
            const formData = new FormData(); // Use FormData for file uploads
            formData.append('title', document.getElementById('add-title').value.trim());
            formData.append('eventDate', document.getElementById('add-date').value); // YYYY-MM-DD
            formData.append('startTime', document.getElementById('add-startTime').value);
            formData.append('endTime', document.getElementById('add-endTime').value);
            formData.append('description', document.getElementById('add-description').value.trim());
            const resourcesNodes = document.querySelectorAll('input[name="add-resources"]:checked');
            formData.append('resources', Array.from(resourcesNodes).map(cb => cb.value).join(', '));
            formData.append('responsible', document.getElementById('add-responsible').value.trim());
            const typeEl = document.querySelector('input[name="add-event-type"]:checked');
            formData.append('eventType', typeEl ? typeEl.value : 'Öffentlich'); // Send German value if backend expects it
            formData.append('participantInfo', document.getElementById('add-participantInfo').value.trim());
            const imageFile = addEventImageInput.files[0];

            // Simple Validation
            if (!formData.get('title') || !formData.get('eventDate')) {
                showAddFormFeedback("Title and Date are required fields.", false); addSpinner.classList.add('d-none'); addEventButton.disabled = false; return;
            }

            // Append image file if selected
            if (imageFile) {
                formData.append('eventImage', imageFile, imageFile.name); // Key 'eventImage' must match backend multer field
            }

            // Fetch to Backend (POST with FormData)
            fetch(`${API_BASE_URL}/api/events`, {
                method: 'POST',
                body: formData // Send FormData object, browser sets Content-Type
            })
            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
            .then(({ ok, status, data }) => {
                addSpinner.classList.add('d-none'); addEventButton.disabled = false;
                if (ok && data.success) {
                    if (addForm) addForm.reset();
                    if (addImagePreview) { addImagePreview.style.display = 'none'; addImagePreview.src = '#'; }
                    clearAddFormFeedback();
                    showAddFormFeedback("Event created successfully.", true, "Redirecting to overview...");
                    setTimeout(() => { showView('event-view'); refreshData(); }, 3000);
                } else {
                    throw new Error(data.message || data.error || `Error ${status}`);
                }
            })
            .catch(err => {
                addSpinner.classList.add('d-none'); addEventButton.disabled = false;
                console.error("Error adding event:", err);
                showAddFormFeedback("Communication error: " + err.message, false);
            });
        }
        function showAddFormFeedback(message, isSuccess, secondaryMessage = null) {
             if(!addFormFeedback) return; let c=message; if(secondaryMessage) c+=`<br><small class="text-muted">${secondaryMessage}</small>`; addFormFeedback.innerHTML=c; addFormFeedback.className=`mt-3 alert alert-${isSuccess?'success':'danger'}`;
         }
        function clearAddFormFeedback() {
           if (addFormFeedback) { addFormFeedback.textContent=''; addFormFeedback.className='mt-3'; }
           if (addEventImageInput) { addEventImageInput.value = null; }
           if (addImagePreview) { addImagePreview.style.display = 'none'; addImagePreview.src = '#';}
           const cbs=document.querySelectorAll('input[name="add-resources"]'); cbs.forEach(cb=>cb.checked=false);
           const rPub=document.getElementById('add-type-public'); if(rPub) rPub.checked=true;
           const rPriv=document.getElementById('add-type-private'); if(rPriv) rPriv.checked=false;
        }

        // --- Edit Event Form Handling ---
        function openEditModal(eventId) { // Takes Firestore ID
            if (!editModal || !allEvents || !editFormFeedback || !editImagePreview || !noEditImageText) { console.error("Edit Modal or elements not ready"); return; }
            const event = allEvents.find(e => e.id === eventId);
            if (!event) { showError({ message: "Event not found." }); return; }
            clearEditFormFeedback();

            // Populate fields
            document.getElementById('edit-id').value = event.id; // Set Firestore ID
            document.getElementById('edit-title').value = event[FIELD_TITLE] || '';
            document.getElementById('edit-date').value = event[FIELD_DATE] || ''; // Expects YYYY-MM-DD
            document.getElementById('edit-startTime').value = event[FIELD_START_TIME] || '';
            document.getElementById('edit-endTime').value = event[FIELD_END_TIME] || '';
            document.getElementById('edit-description').value = event[FIELD_DESCRIPTION] || '';
            document.getElementById('edit-responsible').value = event[FIELD_RESPONSIBLE] || '';
            document.getElementById('edit-participantInfo').value = event[FIELD_PARTICIPANT_INFO] || '';

            // Set checkboxes for resources
            const resourcesCheckboxes = document.querySelectorAll('#edit-resources-checkboxes input[type="checkbox"]');
            const eventResources = (event[FIELD_RESOURCES] || '').split(',').map(r => r.trim()).filter(r => r);
            resourcesCheckboxes.forEach(checkbox => { checkbox.checked = eventResources.includes(checkbox.value); });

            // Set radio buttons for event type
            const eventTypeEdit = String(event[FIELD_EVENT_TYPE] || '').trim();
            if (eventTypeEdit === 'Privat') { document.getElementById('edit-type-private').checked = true; }
            else { document.getElementById('edit-type-public').checked = true; }

            // Show current image preview or "no image" text
            if (event[FIELD_IMAGE_URL]) {
                editImagePreview.src = event[FIELD_IMAGE_URL];
                editImagePreview.style.display = 'block';
                noEditImageText.style.display = 'none';
            } else {
                editImagePreview.style.display = 'none';
                editImagePreview.src = '#';
                noEditImageText.style.display = 'block';
            }

            document.getElementById('editEventModalLabel').textContent = `Edit Event: ${event[FIELD_TITLE] || 'Untitled'}`;
            editModal.show();
        }

        function handleSaveChanges() {
            // (No image upload/change handled here for simplicity)
            if (!saveEventButton || !saveSpinner || !editFormFeedback) return;
            saveSpinner.classList.remove('d-none'); saveEventButton.disabled = true; clearEditFormFeedback(); hideMessages();

            const eventId = document.getElementById('edit-id').value;

            // Collect text data + resource checkboxes
            const dateValue = document.getElementById('edit-date').value; // YYYY-MM-DD
            const typeElEdit = document.querySelector('input[name="edit-event-type"]:checked');
            const typeValEdit = typeElEdit ? typeElEdit.value : 'Öffentlich'; // Send German value if backend expects it
            const selectedResources = Array.from(document.querySelectorAll('#edit-resources-checkboxes input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value)
                .join(', ');

            // Create JSON payload (no image)
            const updatedData = {
                [FIELD_TITLE]: document.getElementById('edit-title').value.trim(),
                [FIELD_DATE]: dateValue,
                [FIELD_START_TIME]: document.getElementById('edit-startTime').value,
                [FIELD_END_TIME]: document.getElementById('edit-endTime').value,
                [FIELD_DESCRIPTION]: document.getElementById('edit-description').value.trim(),
                [FIELD_RESOURCES]: selectedResources,
                [FIELD_RESPONSIBLE]: document.getElementById('edit-responsible').value.trim(),
                [FIELD_EVENT_TYPE]: typeValEdit,
                [FIELD_PARTICIPANT_INFO]: document.getElementById('edit-participantInfo').value.trim()
            };

            if (!updatedData[FIELD_TITLE] || !updatedData[FIELD_DATE] || !eventId) {
                showEditFormFeedback("Title and Date are required fields.", false); saveSpinner.classList.add('d-none'); saveEventButton.disabled = false; return;
            }

            // Fetch to Backend (PUT with JSON)
            fetch(`<span class="math-inline">\{API\_BASE\_URL\}/api/events/</span>{eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData) // Send JSON payload
            })
            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
            .then(({ ok, status, data }) => {
                saveSpinner.classList.add('d-none'); saveEventButton.disabled = false;
                if (ok && data.success) {
                    editModal.hide();
                    showSuccess(data.message || "Event updated successfully.");
                    refreshData();
                } else {
                    throw new Error(data.message || data.error || `Error ${status}`);
                }
            })
            .catch(err => {
                saveSpinner.classList.add('d-none'); saveEventButton.disabled = false;
                console.error("Error updating event:", err);
                showEditFormFeedback("Communication error: " + err.message, false);
            });
        }
        function showEditFormFeedback(message, isSuccess) {
            if(!editFormFeedback) return; editFormFeedback.textContent=message; editFormFeedback.className=`mt-3 alert alert-${isSuccess?'success':'danger'}`;
        }
        function clearEditFormFeedback() {
            if(editFormFeedback) { editFormFeedback.textContent=''; editFormFeedback.className='mt-3'; }
            if(editImagePreview) { editImagePreview.style.display = 'none'; editImagePreview.src = '#'; }
            if(noEditImageText) { noEditImageText.style.display = 'none'; }
        }


        // --- Delete Event Handling ---
        async function handleDeleteEvent() {
            if (!deleteEventButton || !deleteSpinner || !editModal) return;
            const eventIdInput = document.getElementById('edit-id');
            const eventId = eventIdInput ? eventIdInput.value : null; // Get Firestore ID
            const title = document.getElementById('edit-title')?.value || 'this event';

            if (!eventId) { showEditFormFeedback("Error: Event ID not found for deletion.", false); return; }

            if (confirm(`Are you sure you want to permanently delete the event "${title}"? (
